<template>
<div>
  <n-tabs type="line" animated>
    <n-tab-pane name="oasis" tab="ç³»ç»Ÿæ¦‚è§ˆ">
        <n-card hoverable>
      <div class="title">[å°ğŸŸè½¬ğŸ”†] - æ™ºæ…§æ¸”ä¸šæ£€æµ‹ä¸é˜²ç›—å®‰å…¨ç³»ç»Ÿ</div>
      <div class="time"> {{ date }} </div>
      <div class="status">
        <n-button strong secondary round type="error">
          æ•°æ®æŠ¥è­¦
        </n-button>
        <p style="margin-left: 28px;"> 0 æ¡</p>
      </div>
      <img style="height: 160px;" src="@/assets/image/xyzq.png">
    </n-card>
    <div style="height: 32px; width: 100%;"></div>
    <n-grid x-gap="12" y-gap="24" cols="3 960:5">
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <PotentialHydrogen class="icon" />
          </n-icon>
          <div class="title">PHå€¼æ¢é’ˆ</div>
          <div class="name">PHæ¢é’ˆ1å·</div>
          <div class="value">7.76</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <Thermometer class="icon" />
          </n-icon>
          <div class="title">æ¸©åº¦æ¢é’ˆ</div>
          <div class="name">æ¸©åº¦æ¢é’ˆ1å·</div>
          <div class="value">18.64Â°C</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <DashboardOutlined class="icon" />
          </n-icon>
          <div class="title">æ°¨æ°®å€¼æ¢é’ˆ</div>
          <div class="name">æ°¨æ°®æ¢é’ˆ1å·</div>
          <div class="value">0.1394 mg/L</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <DissolvedOxygen class="icon" />
          </n-icon>
          <div class="title">æº¶æ°§å€¼æ¢é’ˆ</div>
          <div class="name">æº¶æ°§æ¢é’ˆ1å·</div>
          <div class="value">6.011 mg/L</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <Turbidity class="icon" />
          </n-icon>
          <div class="title">æµŠåº¦æ¢é’ˆ</div>
          <div class="name">æµŠåº¦æ¢é’ˆ1å·</div>
          <div class="value">412åº¦</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <PotentialHydrogen class="icon" />
          </n-icon>
          <div class="title">PHå€¼æ¢é’ˆ</div>
          <div class="name">PHæ¢é’ˆ2å·</div>
          <div class="value">7.12</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <Thermometer class="icon" />
          </n-icon>
          <div class="title">æ¸©åº¦æ¢é’ˆ</div>
          <div class="name">æ¸©åº¦æ¢é’ˆ2å·</div>
          <div class="value">18.94Â°C</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <DashboardOutlined class="icon" />
          </n-icon>
          <div class="title">æ°¨æ°®å€¼æ¢é’ˆ</div>
          <div class="name">æ°¨æ°®æ¢é’ˆ2å·</div>
          <div class="value">0.1839 mg/L</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <DissolvedOxygen class="icon" />
          </n-icon>
          <div class="title">æº¶æ°§æ¢é’ˆ</div>
          <div class="name">æº¶æ°§æ¢é’ˆ2å·</div>
          <div class="value">5.42 mg/L</div>
        </div>
      </n-grid-item>
      <n-grid-item class="item-container">
        <div class="card">
          <n-icon class="icon" size="40" color="#ffffff">
            <Turbidity class="icon" />
          </n-icon>
          <div class="title">æµŠåº¦æ¢é’ˆ</div>
          <div class="name">æµŠåº¦æ¢é’ˆ2å·</div>
          <div class="value">398åº¦</div>
        </div>
      </n-grid-item>
    </n-grid>
    </n-tab-pane>

    <n-tab-pane name="the beatles" tab="è®¾å¤‡æ³¨å†Œ">
        <n-table :single-line="true">
        <thead class="title">
          <tr>
            <th>æ³¨å†ŒID</th>
            <th>è®¾å¤‡åç§°</th>
            <th>è®¾å¤‡çŠ¶æ€</th>
            <th>IPåœ°å€</th>
            <th>å¿ƒè·³é—´éš”</th>
            <th>æ‰€åœ¨åŒºåŸŸ</th>
            <th>è¿è¡ŒçŠ¶æ€</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(rows, index) in tableItems">
            <td v-for="item in rows">
              {{ item }}
            </td>
            <td>
              <n-button strong secondary type="success">
                è‰¯å¥½
              </n-button>
            </td>
          </tr>
        </tbody>
      </n-table>
    </n-tab-pane>
    <n-tab-pane name="jay chou" tab="æ•°æ®æ„ŸçŸ¥">
      <n-grid item-responsive x-gap="12" y-gap="12" cols="1 512:2">
        <n-grid-item class="item-container">
          <high-charts style="min-width: 50%; margin: auto; height:320px;" :options="options_1" :updateArgs="updateArgs" />
        </n-grid-item>
        <n-grid-item class="item-container">
          <high-charts style="min-width: 50%;  margin: auto; height:320px;" :options="options_2" :updateArgs="updateArgs" />
        </n-grid-item>
        <n-grid-item class="item-container">
          <high-charts style="min-width: 50%;  margin: auto; height:320px;" :options="options_3" :updateArgs="updateArgs" />
        </n-grid-item>
        <n-grid-item class="item-container">
          <high-charts style="min-width: 50%;  margin: auto; height:320px;" :options="options_4" :updateArgs="updateArgs" />
        </n-grid-item>
      </n-grid>
    </n-tab-pane>
  </n-tabs>


</div>
</template>

<script lang="ts">
import { NIcon, NGrid, NGridItem, NCard, NButton } from 'naive-ui'
import { DashboardOutlined } from '@vicons/antd'
import {
  PotentialHydrogen,
  Thermometer,
  DissolvedOxygen,
  Turbidity
} from '@/components/icons'
import { Chart } from 'highcharts-vue'
import mqtt from 'mqtt'

let client: mqtt.MqttClient
const connection = {
  host: '43.136.133.43',
  port: 8083,
  endpoint: '/mqtt',
  clean: true,
  connectTimeout: 10000,
  reconnectPeriod: 2000,
  clientId: 'mqttjs_3be2c321',
  username: 'emqx_test',
  password: 'emqx_test',
}
export default defineComponent({
  name: "System",
  components: {
    HighCharts: Chart,
    NCard,
    NIcon,
    NGrid,
    NGridItem,
    NButton,
    DashboardOutlined,
  },
  data() {
    let timer: any;
    let dataArray: any[] = []
    let timestamp: number = 0
    let o2Data: number[][] = []
    let nhData: number[][] = []
    let turData: number[][] = []
    let tdsData: number[][] = []
    let watData: number[][] = []
    let phData: number[][] = []
    let updateArgs: any[] = [true, true, { duration: 500 }]
    let tableItems = [
      ['xyzq-mqtt-001', 'PHæ¢é’ˆ1å·', 'å·²è¿æ¥', '10.218.17.167:18000', '160s', 'ä¸œå—ä¸€åŒº',],
      ['xyzq-mqtt-002', 'æ¸©åº¦æ¢é’ˆ1å·', 'å·²è¿æ¥', '10.218.17.167:18001', '160s', 'ä¸œå—äºŒåŒº',],
      ['xyzq-mqtt-003', 'æ°¨æ°®æ¢é’ˆ1å·', 'å·²è¿æ¥', '10.218.17.167:18002', '160s', 'ä¸œå—ä¸‰åŒº',],
      ['xyzq-mqtt-004', 'æº¶æ°§æ¢é’ˆ1å·', 'å·²è¿æ¥', '10.218.17.167:18003', '160s', 'ä¸­å¿ƒä¸€åŒº',],
      ['xyzq-mqtt-005', 'æµŠåº¦æ¢é’ˆ1å·', 'å·²è¿æ¥', '10.218.17.167:18004', '160s', 'ä¸­å¿ƒäºŒåŒº',],
      ['xyzq-mqtt-006', 'PHæ¢é’ˆ2å·', 'å·²è¿æ¥', '10.218.17.167:18005', '160s', 'ä¸œå—ä¸€åŒº',],
      ['xyzq-mqtt-007', 'æ¸©åº¦æ¢é’ˆ2å·', 'å·²è¿æ¥', '10.218.17.167:18006', '160s', 'ä¸œå—äºŒåŒº',],
      ['xyzq-mqtt-008', 'æ°¨æ°®æ¢é’ˆ2å·', 'å·²è¿æ¥', '10.218.17.167:18007', '160s', 'ä¸œå—ä¸‰åŒº',],
      ['xyzq-mqtt-009', 'æº¶æ°§æ¢é’ˆ2å·', 'å·²è¿æ¥', '10.218.17.167:18008', '160s', 'ä¸­å¿ƒä¸€åŒº',],
      ['xyzq-mqtt-010', 'æµŠåº¦æ¢é’ˆ2å·', 'å·²è¿æ¥', '10.218.17.167:18009', '160s', 'ä¸­å¿ƒäºŒåŒº',],
      ['xyzq-mqtt-011', 'æº¶æ°§æœº-01', 'å·²è¿æ¥', '10.218.17.167:18010', '240s', 'ä¸œå—ä¸€åŒº',],
      ['xyzq-mqtt-012', 'æº¶æ°§æœº-02', 'å·²è¿æ¥', '10.218.17.167:18011', '240s', 'ä¸œå—äºŒåŒº',],
      ['xyzq-mqtt-013', 'æº¶æ°§æœº-03', 'å·²è¿æ¥', '10.218.17.167:18012', '240s', 'ä¸œå—ä¸‰åŒº',],
      ['xyzq-mqtt-014', 'æº¶æ°§æœº-04', 'å·²è¿æ¥', '10.218.17.167:18013', '240s', 'ä¸­å¿ƒä¸€åŒº',],
      ['xyzq-mqtt-015', 'æº¶æ°§æœº-05', 'å·²è¿æ¥', '10.218.17.167:18014', '240s', 'ä¸­å¿ƒäºŒåŒº',],
    ]
    return {
      timer,
      timestamp,

      o2Data,
      nhData,
      turData,
      tdsData,
      phData,
      watData,
      updateArgs,
      date: new Date().toLocaleString(),
      tableItems,
      options_1: {
        chart: {
          type: 'areaspline'
        },
        title: {
          text: 'æº¶æ°§é‡ä¸æ°¨æ°®å€¼é‡‡é›†'
        },
        yAxis: [
          {
            title: {
              text: '(O)mg/L'
            },
          },
          {
            title: {
              text: '(N)mg/L'
            },
            opposite: true
          }
        ],
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
        },
        series: [
          {
            name: "æº¶æ°§é‡",
            data: [],
          },
          {
            name: "æ°¨æ°®å€¼",
            data: [],

          }
        ]
      },

      options_2: {
        chart: {
          type: 'spline'
        },
        title: {
          text: 'æµŠåº¦ä¸å›ºä½“æº¶è§£é‡é‡‡é›†'
        },
        yAxis: [
          {
            title: {
              text: 'NTU'
            }
          },
          {
            title: {
              text: 'ppm'
            },
            opposite: true
          },
        ],
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
        },
        series: [
          {
            name: "TURæ¢é’ˆ",
            tooltip: {
              valueSuffix: ''
            },
            data: []
          },
          {
            name: "TDSæ¢é’ˆ",
            tooltip: {
              valueSuffix: ''
            },
            data: []
          },
        ]
      },

      options_3: {
        chart: {
          type: 'spline'
        },
        title: {
          text: 'PHå€¼é‡‡é›†'
        },
        yAxis: [
          {
            title: {
              text: '(h+)'
            },
            max: 9.00,
            min: 4.00
          }
        ],
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
        },
        series: [
          {
            name: "PHæ¢é’ˆ(E-210)",
            tooltip: {
              valueSuffix: ''
            },
            data: []
          }
        ]
      },
      options_4: {
        chart: {
          type: 'spline'
        },
        title: {
          text: 'æ°´æ¸©é‡‡é›†'
        },
        yAxis: [
          {
            title: {
              text: 'Â°C'
            },
            max: 40.00,
            min: 0.00
          }
        ],
        tooltip: {
          headerFormat: '<b>{series.name}</b><br>',
          pointFormat: '{point.x:%e. %b}: {point.y:.2f}'
        },
        series: [
          {
            name: "DS18B20",
            tooltip: {
              valueSuffix: ''
            },
            data: []
          }
        ]
      }
    }
  },

  methods: {
    createConnection() {
      const { host, port, endpoint, ...options } = connection
      const connectUrl = `ws://${host}:${port}${endpoint}`

      try {
        client = mqtt.connect(connectUrl, options)
        console.info("Connect.....")
      } catch (error) {
        console.error('Connection Filed', error)
      }

      client.on('connect', () => {
        console.info('Connection succeeded!')
        client.subscribe('/xyzq/collect')
      })
      client.on('error', (error: any) => {
        console.log('Connection failed', error)
      })
      client.on('message', (topic: string, message: string) => {
        let data = JSON.parse(message)
        let timestamp = new Date().getTime()
        if (this.turData.length >= 10) {
          this.turData.shift()
          this.tdsData.shift()
          this.phData.shift()
          this.watData.shift()
        }
        this.turData.push([timestamp, data.TUR])
        this.tdsData.push([timestamp, data.TDS])
        this.phData.push([timestamp, data.PH])
        this.watData.push([timestamp, data.WAT])
        console.log(`Received message ${message} from topic ${topic}`)
      })
    }
  },

  mounted() {
    let that = this
    this.createConnection()
    this.timer = setInterval(function () {
      that.date = new Date().toLocaleString()
      that.timestamp = new Date().getTime()
      if (that.o2Data.length >= 10) {
        that.o2Data.shift()
        that.nhData.shift()
      }
      that.o2Data.push([that.timestamp, Math.random() * 0.2 + 4.8])
      that.nhData.push([that.timestamp, Math.random() * 0.1 + 0.1])
    }, 1000)
  },

  watch: {
    o2Data: {
      handler(value) {
        this.options_1.series[0].data = value
      },
      deep: true
    },
    nhData: {
      handler(value) {
        this.options_1.series[1].data = value
      },
      deep: true
    },
    turData: {
      handler(value) {
        this.options_2.series[0].data = value
      },
      deep: true
    },
    tdsData: {
      handler(value) {
        this.options_2.series[1].data = value
      },
      deep: true
    },
    phData: {
      handler(value) {
        this.options_3.series[0].data = value
      },
      deep: true
    },
    watData: {
      handler(value) {
        this.options_4.series[0].data = value
      },
      deep: true
    }
  },
  // é”€æ¯æ—¶æ¸…é™¤è®¡æ—¶å™¨
  beforeDestroy: function () {
    if (this.timer) {
      clearInterval(this.timer)
    }
  }

})
</script>




<style lang="scss" scoped>
.title {
  th {
    font-weight: 800;
  }
}
.card {
  width: 180px;
  height: 200px;
  border-radius: 16px;
  background: linear-gradient(45deg, #56ccf2, #2f80ed);

  .icon {
    position: absolute;
    margin-top: 8px;
    margin-left: 0px;
  }

  .title {
    position: absolute;
    margin-top: 24px;
    margin-left: 72px;
    font-weight: 800;
  }

  .name {
    position: absolute;
    font-weight: 800;
    font-size: 120%;
    margin-top: 80px;
    margin-left: 48px;
  }

  .value {
    position: absolute;
    margin-top: 150px;
    margin-left: 24px;
    font-weight: 800;
    font-size: 160%;
  }
}

.n-card {
  max-width: 94%;
  margin: auto;

  .title {
    position: absolute;
    margin-left: 360px;
    font-size: 200%;
  }

  .time {
    position: absolute;
    margin-left: 480px;
    margin-top: 72px;
    font-size: 200%;
  }

  .status {
    float: right;
  }
}
</style>
